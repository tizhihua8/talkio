# Avatar é¡¹ç›®çŠ¶æ€æŠ¥å‘Š

> æ›´æ–°æ—¥æœŸï¼š2026-02-18
> åŸºäºä»£ç é™æ€å®¡è®¡ï¼Œåæ˜ å½“å‰ `main` åˆ†æ”¯å®é™…çŠ¶æ€

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

Avatar æ˜¯ä¸€æ¬¾æœ¬åœ°ä¼˜å…ˆçš„ç§»åŠ¨ç«¯å¤šæ¨¡å‹ AI èŠå¤©å®¢æˆ·ç«¯ï¼Œæ ¸å¿ƒç†å¿µä¸º"æ¨¡å‹å³è”ç³»äºº"ã€‚æ”¯æŒå¤š Provider æ¥å…¥ã€èº«ä»½å¡ç³»ç»Ÿã€MCP å·¥å…·è°ƒç”¨ã€ç¾¤èŠåä½œï¼Œæ•°æ®å®Œå…¨å­˜å‚¨åœ¨è®¾å¤‡æœ¬åœ°ã€‚

**æŠ€æœ¯æ ˆ**ï¼šExpo SDK 54 Â· React Native 0.81 Â· React 19 Â· Zustand Â· SQLite + Drizzle Â· NativeWind Â· Vercel AI SDK Â· MCP SDK

---

## äºŒã€åŠŸèƒ½å®Œæˆåº¦

### P0 â€” MVP å¿…é¡»ï¼ˆ10/10 âœ…ï¼‰

| åŠŸèƒ½ | å®ç° | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| å›› Tab å¯¼èˆª | âœ… | `app/(tabs)/_layout.tsx` â€” å¯¹è¯/æ¨¡å‹/è§’è‰²/è®¾ç½® |
| ä¾›åº”å•†ç®¡ç† | âœ… | `src/stores/provider-store.ts` â€” CRUD + è¿æ¥æµ‹è¯• |
| æ¨¡å‹åˆ—è¡¨æ‹‰å– | âœ… | è°ƒç”¨ `/models` æ¥å£è‡ªåŠ¨è·å– |
| æ¨¡å‹èƒ½åŠ›æ¨æ–­ | âœ… | æ ¹æ® model ID å…³é”®è¯æ¨æ–­ Vision/Tools/Reasoning |
| å•èŠä¼šè¯ | âœ… | `src/services/chat-service.ts` â€” æµå¼ SSE + AbortController |
| ä¼šè¯åˆ—è¡¨ | âœ… | `app/(tabs)/chats/index.tsx` â€” æœ€è¿‘å¯¹è¯ + æœ€åæ¶ˆæ¯æ‘˜è¦ |
| Markdown æ¸²æŸ“ | âœ… | ä»£ç é«˜äº® + Mermaid å›¾è¡¨ + HTML é¢„è§ˆ |
| èº«ä»½å¡ç³»ç»Ÿ | âœ… | `src/stores/identity-store.ts` â€” åˆ›å»º/ç¼–è¾‘/æŒ‚è½½/å¸è½½ |
| åŠ¨æ€ System Prompt | âœ… | æŒ‚è½½èº«ä»½å¡å API è¯·æ±‚è‡ªåŠ¨æ³¨å…¥ system æ¶ˆæ¯ |
| æœ¬åœ°æ•°æ®æŒä¹…åŒ– | âœ… | MMKVï¼ˆKV åŠ å¯†ï¼‰+ SQLiteï¼ˆç»“æ„åŒ–ï¼‰+ Drizzle ORM |

### P1 â€” æ ¸å¿ƒå·®å¼‚åŒ–ï¼ˆ7/9ï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å¤šæ¨¡å‹ç¾¤èŠ | âœ… | `conv.type === "group"` + å¤šå‚ä¸è€…ç»“æ„ |
| @ è§¦å‘å®šå‘ | âœ… | `src/utils/mention-parser.ts` è§£æ @ æåŠ |
| ç¾¤èŠèº«ä»½åˆ†é… | âœ… | æ¯ä¸ªå‚ä¸è€…ç‹¬ç«‹ç»‘å®šèº«ä»½å¡ |
| æ¨¡å‹èº«ä»½æ ‡ç­¾ | âœ… | `senderModelId` + `senderName` åŒºåˆ†å‘è¨€è€… |
| æ€ç»´é“¾æŠ˜å  | âœ… | `reasoningContent` + `reasoningDuration` æ”¯æŒæŠ˜å  |
| MCP å·¥å…·æ¡†æ¶ | âœ… | å·¥å…·æ³¨å†Œ/è°ƒåº¦/æƒé™/follow-up é—­ç¯ |
| èº«ä»½å¡ç»‘å®š MCP | âœ… | `identity.mcpToolIds` + `identity.mcpServerIds` |
| æ¨¡å‹èƒ½åŠ›ä¸»åŠ¨æ¢æµ‹ | ğŸ”´ æœªå®ç° | ä»…æœ‰å…³é”®è¯æ¨æ–­ï¼Œæ— ä¸»åŠ¨è¯·æ±‚éªŒè¯ |
| é•¿æŒ‰èœå• | ğŸ”´ æœªå®ç° | å¤åˆ¶/é‡å†™/ç¿»è¯‘/æ€»ç»“ç­‰äº¤äº’ |

### P2 â€” ä½“éªŒå¢å¼ºï¼ˆ5/13ï¼‰

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| æœ¬åœ° MCP â€” å‰ªè´´æ¿ | âœ… |
| æœ¬åœ° MCP â€” æ—¥å†/æé†’ | âœ…ï¼ˆé»˜è®¤å…³é—­ï¼‰|
| æœ¬åœ° MCP â€” å®šä½ | âœ…ï¼ˆé»˜è®¤å…³é—­ï¼‰|
| è¿œç¨‹ MCP (Streamable HTTP) | âœ… |
| å¯¹è¯åˆ†æ”¯ (Branching) | âœ… |
| å…¨å±€æœç´¢ (FTS5) | âœ… |
| è¯­éŸ³è¾“å…¥ â€” å¼‚æ­¥æ¨¡å¼ | ğŸ”´ |
| è¯­éŸ³è¾“å…¥ â€” å®æ—¶æ¨¡å¼ | ğŸ”´ |
| Artifacts å¡ç‰‡åŒ– | ğŸ”´ |
| é•¿å›¾å¯¼å‡º | ğŸ”´ |
| å¿«æ· Prompt æ  | ğŸ”´ |
| MCP æƒé™æˆæƒå¡ç‰‡ | ğŸ”´ |
| å·¥å…·è°ƒç”¨ç»“æœå¡ç‰‡ | ğŸ”´ |

### å·²ç§»é™¤åŠŸèƒ½

| åŠŸèƒ½ | åŸå›  |
|------|------|
| WebDAV æ•°æ®åŒæ­¥ | ç©ºå£³ UIï¼Œæ— å®é™…åŒæ­¥é€»è¾‘ï¼Œå‡­æ®æ˜æ–‡è½ç›˜å­˜åœ¨å®‰å…¨éšæ‚£ã€‚å·²ç”¨å¤‡ä»½/æ¢å¤è¦†ç›–è·¨è®¾å¤‡è¿ç§»éœ€æ±‚ |

---

## ä¸‰ã€å®‰å…¨å®¡è®¡çŠ¶æ€

### å·²ä¿®å¤ âœ…

| ç¼–å· | é—®é¢˜ | ä¿®å¤æ–¹æ¡ˆ |
|------|------|----------|
| **ç™½å±** | `expo-http-server` é¡¶å±‚ import åœ¨ç”Ÿäº§åŒ…å´©æºƒ | æ”¹ä¸º `require()` æ‡’åŠ è½½ + try-catch |
| **P0-2** | Config Server æ— è®¤è¯ + CORS `*` | æ¯æ¬¡å¯åŠ¨ç”Ÿæˆ 6 ä½é…å¯¹ç ï¼ŒæœåŠ¡ç«¯æ ¡éªŒï¼Œç§»é™¤å¼€æ”¾ CORS |
| **P0-3** | WebView `originWhitelist={['*']}` + Mermaid `securityLevel: 'loose'` | æ”¶ç´§ä¸º `["https://"]` + `'strict'` |
| **P1-1** | `READ_CONTACTS` æƒé™å£°æ˜ä½†æœªä½¿ç”¨ | ç§»é™¤ Android + iOS å£°æ˜ |

### å·²çŸ¥é£é™©ï¼ˆæœ‰æ„ä¿ç•™ï¼‰

| ç¼–å· | é—®é¢˜ | ä¿ç•™åŸå›  |
|------|------|----------|
| **P0-1** | Android å…¨å±€ cleartext traffic | ç¦ç”¨ä¼šå¯¼è‡´ Ollama ç­‰ HTTP provider æ— æ³•è¿æ¥ã€‚å¯æ”¹ç”¨ Network Security Config ç™½åå•åŒ– |
| **P0-3 å‰©ä½™** | WebView åŠ è½½è¿œç¨‹ CDN è„šæœ¬ (tailwind/mermaid) | éœ€è¦ bundle æœ¬åœ°åŒ–èµ„æº + å¼•å…¥ HTML sanitizerï¼Œå·¥ä½œé‡è¾ƒå¤§ |
| **P0-4** | MMKV åŠ å¯† key å­˜äºæœªåŠ å¯† MMKV å®ä¾‹ | è¿ç§»åˆ°ç³»ç»Ÿ Keychain/Keystore æ¶‰åŠæ•°æ®è¿ç§»ï¼Œé«˜é£é™© |

### å·¥ç¨‹åŒ–å¾…æ”¹è¿›

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| ESLint `any` æ²»ç† | é…ç½®å·²ç¦æ­¢ä½†ä»£ç ä¸­ä»å­˜åœ¨ |
| CI/CD | æ—  GitHub Actions |

---

## å››ã€é¡¹ç›®ç»“æ„

```
avatar/
â”œâ”€â”€ app/                        # é¡µé¢è·¯ç”± (expo-router)
â”‚   â”œâ”€â”€ (tabs)/
â”‚   â”‚   â”œâ”€â”€ chats/              # å¯¹è¯åˆ—è¡¨ + èŠå¤©
â”‚   â”‚   â”œâ”€â”€ experts/            # æ¨¡å‹æµè§ˆå™¨
â”‚   â”‚   â”œâ”€â”€ discover/           # èº«ä»½å¡ + MCP å·¥å…·ç®¡ç†
â”‚   â”‚   â””â”€â”€ settings/           # è®¾ç½® (5 é¡µ: ä¸»é¡µ/ä¾›åº”å•†/ä¾›åº”å•†ç¼–è¾‘/éšç§/ç½‘é¡µé…ç½®)
â”‚   â””â”€â”€ chat/[id].tsx           # èŠå¤©è¯¦æƒ…é¡µ
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ chat/               # ChatInput, MessageBubble, IdentitySlider
â”‚   â”‚   â”œâ”€â”€ common/             # HtmlPreview, ModelAvatar, BottomSheet, EmptyState
â”‚   â”‚   â””â”€â”€ markdown/           # MarkdownRenderer, MermaidRenderer, CodeBlock
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ api-client.ts       # ç»Ÿä¸€ AI API è¯·æ±‚ + æµå¼è§£æ
â”‚   â”‚   â”œâ”€â”€ chat-service.ts     # èŠå¤©ä¸šåŠ¡é€»è¾‘ (æ¶ˆæ¯å‘é€/å·¥å…·è°ƒç”¨/follow-up)
â”‚   â”‚   â”œâ”€â”€ config-server.ts    # å±€åŸŸç½‘é…ç½®æœåŠ¡ (å¸¦é…å¯¹ç è®¤è¯)
â”‚   â”‚   â”œâ”€â”€ backup-service.ts   # å¤‡ä»½å¯¼å‡º/æ¢å¤ (äº‹åŠ¡ä¿æŠ¤)
â”‚   â”‚   â”œâ”€â”€ built-in-tools.ts   # æœ¬åœ°å†…ç½® MCP å·¥å…· (å‰ªè´´æ¿/æ—¥å†/ä½ç½®)
â”‚   â”‚   â”œâ”€â”€ mcp-client.ts       # MCP SDK å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ mcp/                # MCP è¿æ¥ç®¡ç† + RN Transport
â”‚   â”‚   â””â”€â”€ logger.ts           # æ—¥å¿—æœåŠ¡
â”‚   â”œâ”€â”€ stores/                 # Zustand çŠ¶æ€ (chat/provider/identity/settings)
â”‚   â”œâ”€â”€ storage/                # MMKV + SQLite (å« web é™çº§)
â”‚   â”œâ”€â”€ i18n/                   # å›½é™…åŒ– (en/zh)
â”‚   â””â”€â”€ types/                  # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ db/schema.ts                # Drizzle ORM schema
â”œâ”€â”€ modules/expo-ip/            # è‡ªå®šä¹‰åŸç”Ÿæ¨¡å—
â””â”€â”€ plugins/                    # Expo config æ’ä»¶ (cleartext/ç­¾å/devåç¼€)
```

---

## äº”ã€æ•°æ®åº“ Schema

### conversations

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT PK | UUID |
| type | TEXT | `single` / `group` |
| title | TEXT | å¯¹è¯æ ‡é¢˜ |
| participants | TEXT (JSON) | å‚ä¸è€…æ•°ç»„ `[{modelId, identityId}]` |
| lastMessage | TEXT | æœ€åæ¶ˆæ¯æ‘˜è¦ |
| lastMessageAt | TEXT | æœ€åæ¶ˆæ¯æ—¶é—´ |
| pinned | INTEGER | æ˜¯å¦ç½®é¡¶ |

### messages

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT PK | UUID |
| conversationId | TEXT FK | å…³è”ä¼šè¯ (CASCADE åˆ é™¤) |
| role | TEXT | `user` / `assistant` / `tool` |
| content | TEXT | æ¶ˆæ¯å†…å®¹ |
| senderModelId | TEXT | å‘é€æ¨¡å‹ ID |
| senderName | TEXT | å‘é€è€…æ˜¾ç¤ºå |
| identityId | TEXT | æŒ‚è½½çš„èº«ä»½å¡ ID |
| reasoningContent | TEXT | æ€ç»´é“¾å†…å®¹ |
| reasoningDuration | INTEGER | æ€è€ƒè€—æ—¶ (ms) |
| toolCalls | TEXT (JSON) | å·¥å…·è°ƒç”¨è¯·æ±‚ |
| toolResults | TEXT (JSON) | å·¥å…·è°ƒç”¨ç»“æœ |
| branchId | TEXT | åˆ†æ”¯ ID |
| parentMessageId | TEXT | åˆ†æ”¯çˆ¶æ¶ˆæ¯ ID |
| images | TEXT (JSON) | ç”¨æˆ·é™„åŠ å›¾ç‰‡ |
| isStreaming | INTEGER | æ˜¯å¦æ­£åœ¨æµå¼è¾“å‡º |

ç´¢å¼•ï¼š`idx_messages_conversation` (conversationId), `idx_messages_branch` (branchId)

---

## å…­ã€åŠŸèƒ½ç»Ÿè®¡

| ç±»åˆ« | å·²å®Œæˆ | æœªå®Œæˆ | æ€»è®¡ |
|------|--------|--------|------|
| P0 MVP | 10 | 0 | 10 |
| P1 æ ¸å¿ƒå·®å¼‚åŒ– | 7 | 2 | 9 |
| P2 ä½“éªŒå¢å¼º | 6 | 7 | 13 |
| **æ€»è®¡** | **23** | **9** | **32** |

**æ•´ä½“åŠŸèƒ½å®Œæˆåº¦ï¼š~72%**  
**å®‰å…¨ä¿®å¤å®Œæˆåº¦ï¼š4/7 å·²ä¿®å¤ï¼ˆ3 é¡¹æœ‰æ„ä¿ç•™ï¼‰**

---

## ä¸ƒã€ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆå‘å¸ƒå‰ï¼‰

1. å®ç° P1 **é•¿æŒ‰èœå•**ï¼ˆå¤åˆ¶/é‡å†™/ç¿»è¯‘/æ€»ç»“ï¼‰â€” ç”¨æˆ·é«˜é¢‘æ“ä½œ
2. è€ƒè™‘ **Network Security Config** æ›¿ä»£å…¨å±€ cleartextï¼ˆä¿ç•™ localhost ç™½åå•ï¼‰
3. æ·»åŠ åŸºç¡€ **GitHub Actions** CIï¼ˆtypecheck + lintï¼‰

### ä¸­æœŸ

4. WebView CDN è„šæœ¬æœ¬åœ°åŒ–ï¼ˆæ¶ˆé™¤è¿œç¨‹ä¾èµ–ï¼‰
5. å‡­æ®å­˜å‚¨è¿ç§»åˆ°ç³»ç»Ÿ Keychain/Keystore
6. æ¶ˆé™¤ä»£ç ä¸­çš„ `any` ç±»å‹

### é•¿æœŸ

7. æŒ‰éœ€å®ç° P2 ä½“éªŒå¢å¼ºåŠŸèƒ½ï¼ˆè¯­éŸ³/Artifacts/å·¥å…·ç»“æœå¡ç‰‡ç­‰ï¼‰

---

*åŸºäº commit `18c480c` åˆ†æç”Ÿæˆ*
