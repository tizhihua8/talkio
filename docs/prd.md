# Avatar — 移动端多模型 AI Chat 客户端产品需求文档 (PRD)

> 版本：v0.1 | 日期：2026-02-10

---

## 1. 产品愿景

打造一款**"像微信一样自然、像指挥部一样强大"**的移动端 AI 客户端。

用户不再面对冰冷的"助手列表"，而是拥有一个由多个 AI 模型组成的**"专家通讯录"**——随时私聊、按需组群、一键变身。

---

## 2. 用户故事

### 2.1 日常对话

> 作为一个普通用户，我希望打开 App 就像打开微信一样，点击一个模型直接开始聊天，不需要任何配置。

### 2.2 专业模式

> 作为一个开发者，我希望在聊代码时，能给模型临时挂载"架构师"身份，让它更专业地回答；聊完后一键卸载，恢复白板状态。

### 2.3 多模型协作

> 作为一个需要决策的用户，我希望把 DeepSeek 和 Claude 拉进一个群聊，让它们针对同一个问题各自发表意见，帮我做出更好的判断。

### 2.4 模型切换不丢上下文

> 作为一个频繁切换模型的用户，我希望从 Gemini 切换到 DeepSeek 时，新模型能清楚地知道之前的回复是"别人说的"，而不是以为是自己说的。

### 2.5 手机系统联动

> 作为一个效率控，我希望 AI 能直接读取我的日历、剪贴板，帮我安排提醒，而不只是文字聊天。

### 2.6 零配置上手

> 作为一个新用户，我希望填完 API Key 后，App 自动拉取可用模型并识别它们的能力（能不能看图、能不能调工具），不需要我手动勾选。

---

## 3. 功能清单与优先级

### P0 — MVP 必须 (第一版发布)

| 编号 | 功能 | 描述 |
|------|------|------|
| F-01 | **四 Tab 导航** | 消息 / 通讯录 / 发现 / 我 |
| F-02 | **供应商管理** | 添加供应商（Name, Base URL, API Key），连接测试 |
| F-03 | **模型列表拉取** | 调用 /models 接口自动获取供应商下的模型 |
| F-04 | **模型能力推断** | 根据 model ID 关键词自动推断 Vision/Tools/Reasoning 标签 |
| F-05 | **单聊会话** | 选择模型 → 进入聊天 → 流式输出 (SSE) |
| F-06 | **消息列表** | 最近会话列表，显示最后一条消息摘要 |
| F-07 | **Markdown 渲染** | 聊天气泡内支持 Markdown、代码高亮 |
| F-08 | **身份卡系统** | 创建/编辑身份卡（System Prompt + Temperature），在单聊中挂载/卸载 |
| F-09 | **动态 System Prompt 注入** | 挂载身份卡后，API 请求自动注入对应的 system 消息和参数 |
| F-10 | **本地数据持久化** | 会话、消息、配置使用 MMKV + SQLite 存储 |

### P1 — 核心差异化 (第二版)

| 编号 | 功能 | 描述 |
|------|------|------|
| F-11 | **多模型群聊** | 勾选多个模型发起群聊，每个模型独立头像 |
| F-12 | **@ 触发机制** | 输入 @ 弹出成员选择器，只有被 @ 的模型发起 API 请求 |
| F-13 | **群聊身份分配** | 给群内每个模型分别挂载不同的身份卡 |
| F-14 | **模型身份标签 (name 字段)** | 消息携带来源模型标识，解决切换模型时"分不清敌我"的问题 |
| F-15 | **模型能力检测** | 一键发送探测请求，自动校准 Vision/Tools/Reasoning 能力标签 |
| F-16 | **思维链折叠** | R1/o1 模型的 reasoning_content 默认折叠，显示耗时，点击展开 |
| F-17 | **MCP 工具框架** | 定义全局工具 + 身份绑定工具的注册与调度机制 |
| F-18 | **身份卡绑定 MCP** | 身份卡可配置关联的 MCP 工具列表 |
| F-19 | **长按菜单** | 复制、重写、翻译、总结，复刻微信长按气泡交互 |

### P2 — 体验增强 (第三版)

| 编号 | 功能 | 描述 |
|------|------|------|
| F-20 | **本地 MCP — 剪贴板** | 读取系统剪贴板内容供模型使用 |
| F-21 | **本地 MCP — 日历/提醒** | 读取日历、写入提醒事项 |
| F-22 | **本地 MCP — 定位** | 获取 GPS 位置供模型使用 |
| F-23 | **远程 MCP (SSE)** | 通过 SSE 连接远程 MCP Server |
| F-24 | **语音输入 — 异步模式** | 按住说话 → 转文字 → 发送 |
| F-25 | **语音输入 — 实时模式** | 双工通话界面 |
| F-26 | **对话分支 (Branching)** | 长按消息 → 分叉，尝试不同讨论路径 |
| F-27 | **Artifacts 卡片化** | 代码/图表以卡片展示，点击全屏交互 |
| F-28 | **全局搜索** | 全文检索历史消息（SQLite FTS5） |
| F-29 | **数据同步** | WebDAV / 二维码同步配置和聊天记录 |
| F-30 | **长图导出** | 勾选消息 → 生成分享长图 |
| F-31 | **快捷 Prompt 栏** | 输入框上方常用指令横向滚动条 |
| F-32 | **MCP 权限授权卡片** | 工具调用时在气泡内弹出确认卡片 |
| F-33 | **工具调用结果卡片** | 类微信位置/名片卡片样式展示 MCP 调用结果 |

---

## 4. 核心交互细节

### 4.1 身份卡挂载交互

| 步骤 | 操作 | 视觉反馈 |
|------|------|----------|
| 1 | 进入单聊，标题显示 "DeepSeek-R1" | 标题栏右侧有小图标（面具/印章） |
| 2 | 点击标题栏 | 标题下方弹出横向滚动的身份卡列表 |
| 3 | 选择"架构师" | 标题变为 "DeepSeek-R1 · 架构师"，可有细微背景色变化 |
| 4 | 点击 × 或再次点击标题栏选"卸载" | 标题恢复为 "DeepSeek-R1" |

### 4.2 群聊 @ 交互

| 步骤 | 操作 | 视觉反馈 |
|------|------|----------|
| 1 | 在输入框输入 `@` | 弹出成员选择浮窗 |
| 2 | 浮窗显示群成员 | 格式：`DeepSeek-R1 (架构师)` / `Claude-3.5 (默认)` |
| 3 | 选中某个模型 | 输入框插入 `@DeepSeek-R1 ` |
| 4 | 发送消息 | 仅被 @ 的模型发起 API 请求 |
| 5 | 模型回复 | 气泡左侧显示模型头像和名称 |

### 4.3 供应商配置交互

| 步骤 | 操作 | 视觉反馈 |
|------|------|----------|
| 1 | 进入供应商管理，点击 "+" | 弹出表单：Name / Base URL / API Key |
| 2 | 填写完成，点击"连接测试" | Loading → ✅ 连接成功 / ❌ 失败提示 |
| 3 | 点击"拉取模型" | 列表刷出所有可用模型 |
| 4 | 每个模型自动显示能力标签 | 📷 Vision / 🛠️ Tools / 🧠 Reasoning |
| 5 | 点击单个模型的 "⚡️ 检测" | 转圈 2s → 标签更新（亮起/熄灭） |
| 6 | 手动微调（备选） | 点击标签可手动开关 |

---

## 5. 非功能需求

| 维度 | 要求 |
|------|------|
| **性能** | 10000+ 消息列表无卡顿；聊天记录加载 < 100ms；流式首字 < 500ms |
| **存储** | 所有数据本地优先；API Key 加密存储 |
| **隐私** | MCP 调用敏感权限时弹窗确认；身份卸载后自动断开 MCP 连接 |
| **兼容** | iOS 16+ / Android 12+ |
| **离线** | 历史记录离线可查；远程 MCP 不可用时置灰提示 |

---

## 6. 不做的事情

| 功能 | 理由 |
|------|------|
| 移动端本地知识库 (RAG) | 手机端不适合向量数据库，需要时应上 PC |
| 模型间自动对话 | 群聊中模型只响应用户 @，不互相对话（避免死循环和 Token 浪费） |
| 本地 stdio MCP Server | 手机 OS 限制，改用 App 内置原生模块 + 远程 SSE |
| 插件市场 | MVP 阶段不做，身份卡仓库已覆盖核心需求 |

---

## 7. 开发路线图

### 第一阶段：基础骨架 (Week 1-2)

| 任务 | 交付物 |
|------|--------|
| 初始化 Expo 项目 | 项目脚手架、目录结构 |
| 四 Tab 导航 | 底部导航 + 各页面框架 |
| 供应商管理 CRUD | 表单 UI + MMKV 持久化 |
| 模型列表拉取 + 关键词推断 | 通讯录页面 |
| 基础单聊 | 聊天界面 + SSE 流式输出 + FlashList |

### 第二阶段：身份系统 (Week 3-4)

| 任务 | 交付物 |
|------|--------|
| 身份卡 CRUD | 发现页 → 身份卡仓库 |
| 单聊身份挂载 UI | 标题栏滑块 + 动态注入逻辑 |
| Markdown 渲染优化 | 代码高亮、LaTeX |
| 思维链折叠 | reasoning_content 折叠/展开 |
| 长按菜单 | 复制、重写、翻译 |

### 第三阶段：群聊 (Week 5-6)

| 任务 | 交付物 |
|------|--------|
| 群聊创建 | 勾选模型 → 建群 |
| @ 识别 + 调度器 | 输入解析 + 定向 API 调用 |
| name 字段身份标签 | 消息来源标识 |
| 群成员身份分配 | 每个模型独立身份卡 |
| 模型能力检测 | 探测请求 + 能力校准 |

### 第四阶段：MCP + 体验增强 (Week 7-10)

| 任务 | 交付物 |
|------|--------|
| MCP 框架搭建 | 工具注册、调度、权限管理 |
| 本地 MCP（剪贴板、日历） | 首批系统能力集成 |
| 远程 MCP (SSE) | 远程工具连接 |
| 语音输入 | 异步按住说话 |
| 对话分支 | Branching 交互 |
| 全局搜索 | SQLite FTS5 全文检索 |
| 数据同步 | WebDAV 方案 |

---

## 8. 核心架构决策记录

| 决策 | 选择 | 理由 |
|------|------|------|
| 框架 | React Native + Expo | 开发速度快，JS 栈一致性 |
| 列表组件 | FlashList | 比 FlatList 性能好 10x |
| 状态管理 | Zustand | 轻量，比 Redux 更适合消息流 |
| KV 存储 | MMKV | 读写速度原生级，比 AsyncStorage 快 30x |
| 结构化存储 | SQLite | 全文检索 (FTS5)、复杂查询 |
| 样式方案 | NativeWind | Tailwind 语法，快速还原微信 UI |
| 流式输出 | SSE (fetch/EventSource) | 标准协议，兼容所有 LLM API |
| MCP 通信 | SSE (远程) + Native Module (本地) | 移动端不适合 stdio |
| 群聊容器 | 统一 ChatContainer | 单聊是群聊的特例，一套代码覆盖两种模式 |
